/*
 * Copyright 2010, Wen Pu (dexterpu at gmail dot com)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * Check out http://www.cs.illinois.edu/homes/wenpu1/chatbox.html for document
 *
 * Depends on jquery.ui.core, jquery.ui.widiget, jquery.ui.effect
 *
 * Also uses some styles for jquery.ui.dialog
 *
 */

// TODO: implement destroy()
(function(e){e.widget("ui.chatbox",{options:{id:null,title:null,user:null,hidden:false,offset:0,width:300,messageSent:function(e,t,n){this.boxManager.addMsg(t.first_name,n)},boxClosed:function(e){},boxManager:{init:function(e){this.elem=e},addMsg:function(t,n){var r=this;var i=r.elem.uiChatboxLog;var s=document.createElement("div");i.append(s);e(s).hide();var o=false;if(t){var u=document.createElement("b");e(u).text(t+": ");s.appendChild(u)}else{o=true}var a=document.createElement(o?"i":"span");e(a).text(n);s.appendChild(a);e(s).addClass("ui-chatbox-msg");e(s).css("maxWidth",e(i).width());e(s).fadeIn();r._scrollToBottom();if(!r.elem.uiChatboxTitlebar.hasClass("ui-state-focus")&&!r.highlightLock){r.highlightLock=true;r.highlightBox()}},highlightBox:function(){var e=this;e.elem.uiChatboxTitlebar.effect("highlight",{},300);e.elem.uiChatbox.effect("bounce",{times:3},300,function(){e.highlightLock=false;e._scrollToBottom()})},toggleBox:function(){this.elem.uiChatbox.toggle()},_scrollToBottom:function(){var e=this.elem.uiChatboxLog;e.scrollTop(e.get(0).scrollHeight)}}},toggleContent:function(e){this.uiChatboxContent.toggle();if(this.uiChatboxContent.is(":visible")){this.uiChatboxInputBox.focus()}},widget:function(){return this.uiChatbox},_create:function(){var t=this,n=t.options,r=n.title||"No Title",i=(t.uiChatbox=e("<div></div>")).appendTo(document.body).addClass("ui-widget "+"ui-corner-top "+"ui-chatbox").attr("outline",0).focusin(function(){t.uiChatboxTitlebar.addClass("ui-state-focus")}).focusout(function(){t.uiChatboxTitlebar.removeClass("ui-state-focus")}),s=(t.uiChatboxTitlebar=e("<div></div>")).addClass("ui-widget-header "+"ui-corner-top "+"ui-chatbox-titlebar "+"ui-dialog-header").click(function(e){t.toggleContent(e)}).appendTo(i),o=(t.uiChatboxTitle=e("<span></span>")).html(r).appendTo(s),u=(t.uiChatboxTitlebarClose=e('<a href="#"></a>')).addClass("ui-corner-all "+"ui-chatbox-icon ").attr("role","button").hover(function(){u.addClass("ui-state-hover")},function(){u.removeClass("ui-state-hover")}).click(function(e){i.hide();t.options.boxClosed(t.options.id);return false}).appendTo(s),a=e("<span></span>").addClass("ui-icon "+"ui-icon-closethick").text("close").appendTo(u),f=(t.uiChatboxTitlebarMinimize=e('<a href="#"></a>')).addClass("ui-corner-all "+"ui-chatbox-icon").attr("role","button").hover(function(){f.addClass("ui-state-hover")},function(){f.removeClass("ui-state-hover")}).click(function(e){t.toggleContent(e);return false}).appendTo(s),l=e("<span></span>").addClass("ui-icon "+"ui-icon-minusthick").text("minimize").appendTo(f),c=(t.uiChatboxContent=e("<div></div>")).addClass("ui-widget-content "+"ui-chatbox-content ").appendTo(i),h=(t.uiChatboxLog=t.element).addClass("ui-widget-content "+"ui-chatbox-log").appendTo(c),p=(t.uiChatboxInput=e("<div></div>")).addClass("ui-widget-content "+"ui-chatbox-input").click(function(e){}).appendTo(c),d=(t.uiChatboxInputBox=e("<textarea></textarea>")).addClass("ui-widget-content "+"ui-chatbox-input-box "+"ui-corner-all").appendTo(p).keydown(function(n){if(n.keyCode&&n.keyCode==e.ui.keyCode.ENTER){msg=e.trim(e(this).val());if(msg.length>0){t.options.messageSent(t.options.id,t.options.user,msg)}e(this).val("");return false}}).focusin(function(){d.addClass("ui-chatbox-input-focus");var t=e(this).parent().prev();t.scrollTop(t.get(0).scrollHeight)}).focusout(function(){d.removeClass("ui-chatbox-input-focus")});s.find("*").add(s).disableSelection();c.children().click(function(){t.uiChatboxInputBox.focus()});t._setWidth(t.options.width);t._position(t.options.offset);t.options.boxManager.init(t);if(!t.options.hidden){i.show()}},_setOption:function(t,n){if(n!=null){switch(t){case"hidden":if(n)this.uiChatbox.hide();else this.uiChatbox.show();break;case"offset":this._position(n);break;case"width":this._setWidth(n);break}}e.Widget.prototype._setOption.apply(this,arguments)},_setWidth:function(e){this.uiChatboxTitlebar.width(e+"px");this.uiChatboxLog.width(e+"px");this.uiChatboxInput.css("maxWidth",e+"px");this.uiChatboxInputBox.css("width",e-18+"px")},_position:function(e){this.uiChatbox.css("right",e)}})})(jQuery)