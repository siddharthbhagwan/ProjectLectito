var $tbody, button_element, rental_available_at, $rental_data ="", table_row_id, row_number;


city = $("#city").val()
$table = $("<table>")
sub_table_id = "sub_search_results_table_" + <%= params[:book_id] %>
sub_table_id_s = "#" + sub_table_id
row_number = <%= params[:row_number] %>
$(sub_table_id_s).remove()

<% #TODO: add table expand retract (toggle) %>

$final_table ="<tr id='city_<%= params[:book_id] %>'><td colspan='2'><table id='sub_search_results_table_<%= params[:book_id] %>' class='table table-hover table-condensed table-bordered'>"
$table_ending = "</table></td></tr>"
$table_header = "<tr id='sub_search_results_table_header'><th>Price</th><th>Avail@</th><th>Borrow</th></tr>"
$final_table = $final_table + $table_header

if (<%= @users_and_address.length %> === 0) {
  $("#city_<%= params[:book_id] %>").remove();
  $rental_data = "<tr><td colspan='3'> Sorry, this book isnt available in your city </td></tr>";
  $final_table = $final_table + $rental_data + $table_ending

} else {
  <%= i = 0 %>
  <% while i < @users_and_address.length %>
    <%= j = i + 1 %>
    if (<%= @transactions_requested.include?@users_and_address[j].user_id.to_s %>){
      button_element = "<td><input type='button' value='Request Sent' disabled = 'true' class='borrow_button' id='<%= @users_and_address[i].id %>' data-uid='<%= @users_and_address[i].user_id %>' data-ubid='<%= @users_and_address[i].id %>'/></td>";
    }
    else {
      button_element = "<td><input type='button' value='Send Request' class='borrow_button' id='<%= @users_and_address[i].id %>' data-uid='<%= @users_and_address[i].user_id %>' data-ubid='<%= @users_and_address[i].id %>'/></td>";
    }
    rental_available_at = "<td>" + "<%= @users_and_address[j].locality %>" + "/" + "<%= @users_and_address[j].city %>" + "</td>";
    $rental_data = $rental_data + "<tr id='sub_search'><td>" + <%= @users_and_address[i].rental_price %> + "</td>" + rental_available_at + button_element + "</tr>";
    <%= i = i + 2 %>
  <% end %>
  
  $("#city_<%= params[:book_id] %>").remove();
  $final_table = $final_table + $rental_data + $table_ending
}

$("#search_results_table > tbody > tr").eq(row_number).after($final_table);